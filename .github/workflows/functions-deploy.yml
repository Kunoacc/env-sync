name: Deploy Supabase Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'  # Only run when changes are made to functions
  workflow_dispatch:   # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: 'v1.x'
        
    - name: Install Supabase CLI
      run: |
        curl -fsSL https://github.com/supabase/cli/releases/download/v1.60.0/supabase_1.60.0_linux_amd64.deb -o supabase.deb
        sudo dpkg -i supabase.deb
        rm supabase.deb
        
    - name: Login to Supabase
      run: |
        supabase login ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
    - name: Get list of functions
      id: function_list
      run: |
        # Get list of function directories
        FUNCTIONS=$(find ./functions -mindepth 1 -maxdepth 1 -type d -not -path "./functions/node_modules" | sed 's|./functions/||')
        echo "Found functions: $FUNCTIONS"
        echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
        
    - name: Deploy Functions
      run: |
        cd functions
        
        # Deploy each function
        for FUNC in ${{ steps.function_list.outputs.functions }}; do
          echo "Deploying function: $FUNC"
          supabase functions deploy $FUNC --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        done
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        
    - name: Verify Deployment
      run: |
        supabase functions list --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
